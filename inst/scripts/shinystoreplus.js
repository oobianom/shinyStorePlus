/*! shinyStorePlus v1.3 | (c) Written by Obi Obianom, www.obianom.com | all rights reserved 

       _      _                 _____  _                     _____   _             
      | |    (_)               / ____|| |                   |  __ \ | |            
  ___ | |__   _  _ __   _   _ | (___  | |_  ___   _ __  ___ | |__) || | _   _  ___ 
 / __|| '_ \ | || '_ \ | | | | \___ \ | __|/ _ \ | '__|/ _ \|  ___/ | || | | |/ __|
 \__ \| | | || || | | || |_| | ____) || |_| (_) || |  |  __/| |     | || |_| |\__ \
 |___/|_| |_||_||_| |_| \__, ||_____/  \__|\___/ |_|   \___||_|     |_| \__,_||___/
                         __/ |                                                     
                        |___/                                                      


*/

function initialize(t){let n="app"+hashCode(t.appname),e=new Dexie(n);e.version(1).stores({shinyStoresPlus:"++id,app,var,type,value,created"}),retrieveAllInputs(n,e).then(function(t){t.length&&returnValues(t)}),"boolean"==typeof t.input&&t.input&&initializeAllInputs(n,e),"object"==typeof t.input&&t.input.length&&initializeAllInputs(n,e,t.input),"boolean"==typeof t.output&&t.output&&initializeAllOutputs(n,e)}function initdinput(t,n){let e="app"+hashCode(t.appname),u=new Dexie(e);u.version(1).stores({shinyStoresPlus:"++id,app,var,type,value,created"}),retrieveOneInput(e,u,n).then(function(t){console.clear(),initializeAllInputs(e,u,[n]),t.length&&returnValues(t)})}function initializeAllOutputs(t,n,e=null){$.each([".shiny-text-output.shiny-bound-output"],function(u,a){$(a).each(function(u,o){let l=0,r=this,s=$(r).attr("id"),p=$(r).html();$(r).on("DOMSubtreeModified",function(){p=$(r).html(),getInputById(t,s,a,n).then(function(u){null!=u&&(l=u.id),0==l?setInputById(t,s,a,p,e,n):updateInputById(t,s,a,p,l,e,n)})})})})}function initializeAllInputs(t,n,e=null){$.each(["input.shiny-bound-input","textarea.shiny-bound-input","select.shiny-bound-input","input.sw-switchInput"],function(u,a){$(a).each(function(u,o){let l=0,r=a,s=this,p=$(s).attr("id");null==p&&console.log($(s).attr("name")+"is undefined.");let c=$(s).val();$(s).change(function(){c="checkbox"==$(s).attr("type")?(a="checkbox.shiny-bound-input",$(s).is(":checked")):(a=r,$(s).val()),getInputById(t,p,a,n).then(function(u){null!=u&&(l=u.id),0==l?setInputById(t,p,a,c,e,n):updateInputById(t,p,a,c,l,e,n)})}),$(s).keyup(function(){a=r,c=$(s).val(),getInputById(t,p,a,n).then(function(u){null!=u&&(l=u.id),0==l?setInputById(t,p,a,c,e,n):updateInputById(t,p,a,c,l,e,n)})})})});let u=[],a=[];$.each(["div.checkbox-group-buttons:has(button.checkbtn)","div.shiny-bound-input:has(div.shiny-options-group)","div.shiny-bound-input:has(input[type='radio'])","div.shiny-bound-input:has(input[type='text'])"],function(o,l){$(l).each(function(o,r){let s=0,p=$(this).attr("id"),c=$(this).val();$(this).find('input[type="radio"]').change(function(){l="radio.shiny-bound-input",c=$(this).val(),getInputById(t,p,l,n).then(function(u){null!=u&&(s=u.id),0==s?setInputById(t,p,l,c,e,n):updateInputById(t,p,l,c,s,e,n)})}),u[o]=[],$(this).find('input[type="checkbox"]').each(function(u,a){l="checkboxgroup.shiny-bound-input",c=$(this).val();var o=$(this).attr("name");$(this).change(function(){c=[],document.getElementsByName(o).forEach(t=>{t.checked?c.push(t.value):c=removeItemOnce(c,t.value),c=[...new Set(c)]}),getInputById(t,p,l,n).then(function(u){null!=u&&(s=u.id),0==s?setInputById(t,p,l,c,e,n):updateInputById(t,p,l,c,s,e,n)})})});let d=$(this).find('input[type="text"]');1==d.length&&d.change(function(){l="dateinput.shiny-bound-input",c=$(this).val(),getInputById(t,p,l,n).then(function(u){null!=u&&(s=u.id),0==s?setInputById(t,p,l,c,e,n):updateInputById(t,p,l,c,s,e,n)})}),a[o]=[],2==d.length&&d.each(function(){l="dateinputrange.shiny-bound-input",$(this).change(function(){a[o]=[d.first().val(),d.first().next().next().val()],getInputById(t,p,l,n).then(function(u){null!=u&&(s=u.id),0==s?setInputById(t,p,l,a[o],e,n):updateInputById(t,p,l,a[o],s,e,n)})})})})})}function removeItemOnce(t,n){return -1<(n=t.indexOf(n))&&t.splice(n,1),t}function replaceNonAlphanumeric(t){return t.replace(/[^A-Za-z0-9]/g,"")}function timeIntVal(){return Math.floor(Date.now())}function hashCode(t){let n=0;if(0==t.length)return n;for(i=0;i<t.length;i++)n=(n<<5)-n+(ch=t.charCodeAt(i)),n&=n;return n}function retrieveAllInputs(t,n){return n.shinyStoresPlus.where({app:t}).toArray()}function retrieveOneInput(t,n,e){return n.shinyStoresPlus.where({app:t,var:e}).toArray()}function getInputById(t,n,e,u){let a=u.shinyStoresPlus.where({app:t,var:n});return a.toArray().then(function(t){1<t.length&&u.shinyStoresPlus.delete(t[1].id)}),a.first()}function setInputById(t,n,e,u,a,o){let l=!1;(null==a||a.includes(n))&&(l=!0),l&&o.shinyStoresPlus.add({app:t,var:n,type:e,value:u,created:timeIntVal()}).catch(function(t){console.error("Unable to update the input:"+t.stack)})}function updateInputById(t,n,e,u,a,o,l){let r=!1;(null==o||o.includes(n))&&(r=!0),r&&l.shinyStoresPlus.update(a,{app:t,var:n,value:u,created:timeIntVal()})}function clearDatabase(t){console.log("Clearing storage for "+t+"..."),new Dexie(t).delete()}function sendWarning(t){Shiny.setInputValue("transmittedWarningx0x0ssp",JSON.stringify(t))}function returnValues(t){Shiny.setInputValue("transmittedDatax0x",JSON.stringify(t))}function untilEl(t){return new Promise(n=>{if(document.querySelector(t))return n(document.querySelector(t));let e=new MutationObserver(u=>{document.querySelector(t)&&(e.disconnect(),n(document.querySelector(t)))});e.observe(document.body,{childList:!0,subtree:!0})})}Shiny.addCustomMessageHandler("retriever",function(t){void 0!==t&&initialize(t),Array.isArray(t.dinput)&&t.dinput.forEach(n=>{untilEl("#"+n).then(e=>{initdinput(t,n)})})}),Shiny.addCustomMessageHandler("clearStorage",function(t){clearDatabase("app"+hashCode(t))}),$(document).on("shiny:connected",function(t){let n=new URL(window.location.href);var e={};n.searchParams.forEach(function(t,n){e[n]=t}),Shiny.setInputValue("sSP1locationParams",JSON.stringify(e))});
